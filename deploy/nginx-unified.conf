# Nginx for unified backend deployment
# __BACKEND_IP__ and __BACKEND_PORT__ are replaced at container start by docker-entrypoint.sh
# so nginx never parses the hostname "backend" (avoids "host not found in upstream" at startup)
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;
    set $backend_upstream http://__BACKEND_IP__:__BACKEND_PORT__;

    # API proxy – /api/ (e.g. email stub) and /v1/ (engines) to backend
    location /api/ {
        proxy_pass $backend_upstream$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Unified backend – must be before location / so POST /v1/... is proxied (not 405)
    location /v1/ {
        proxy_pass $backend_upstream$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # LLM/Ollama can be slow; allow up to 3 minutes for intent/RAG/explainability
        proxy_connect_timeout 60s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;
    }

    # SPA routing (GET only; POST falls here if path didn't match /v1/)
    location / {
        try_files $uri $uri/ /index.html;
    }
}
